app.factory("Table",["$http",function(e){function a(){this.list=[],this.query={page:1,perPage:"20"}}return a.prototype.init=function(e){return this.error=!1,this.ready=!1,this.list=[],this.query={page:1,perPage:"20"},this.link=e.link,this.callback=e.callback||function(){},e.query&&(this.query=$.extend(this.query,e.query)),this},a.prototype.getList=function(a){var t=this;a=a||t.query.page,t.query.page=a,e({url:t.link,params:t.query,method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(function(e){var a=e.data;a.data?(t.error=!1,t.list=a.data,t.pageCount=parseInt(a.total%t.query.perPage)>0?parseInt(a.total/t.query.perPage)+1:parseInt(a.total/t.query.perPage),t.total=a.total):(t.error=!0,t.errorMsg=a.msg),t.callback(a)}).catch(function(e){t.error=!0,t.errorMsg=e.status}).finally(function(){t.ready=!0})},new a}]),app.directive("tableFloatHeader",["$compile",function(e){return{restrict:"AE",template:'<div class="table-float-header"></div>',link:function(a,t,n,s){function r(){for(var e=i.find("td"),a=$("."+n.floatThead).next("tbody").find("tr").eq(0).find("td"),t=0;t<e.length;t++)e.eq(t).width(a.eq(t).width())}var p=$(t).find(".table-float-header");n.floatElement&&p.html(e($("."+n.floatElement).clone())(a));var i=$("<table></table>");i.html(e($("."+n.floatThead).clone())(a)),$(t).find(".table-float-header").append(i),$(".view").on("scroll",function(){r(),p.css("top",$(this).scrollTop()+"px"),$(this).scrollTop()>70?p.show():p.hide()})}}}]),app.directive("tableFixedTr",function(){return{restrict:"AE",link:function(e,a,t,n){e.$on("repeatFinish",function(){setTimeout(function(){var e=$(a).find("tbody tr").length;if(e>t.tableFixedTr)for(var n=0;n<e-t.tableFixedTr;n++)$(a).find("tbody tr").eq($(a).find("tbody tr").length-1).remove();else if(e<t.tableFixedTr)for(var s=0;s<t.tableFixedTr-e;s++){var r=$("<tr></tr>");r.append("<td colspan='"+$(a).find("thead tr td").length+"'>&#12288;</td>"),$(a).find("tbody").append(r)}})})}}}),app.directive("tablePage",function(){return{restrict:"AE",template:'<div class="table-page"></div>',link:function(e,a,t,n){e.$watch(t.tablePage,function(e){if(e&&e.pageCount&&e.pageCount>1){$(a).find(".table-page").html('<span class="pre">上一页</span>                        <span class="next">下一页</span>'),1==e.query.page?$(a).find(".pre").addClass("disabled"):e.query.page==e.pageCount&&$(a).find(".next").addClass("disabled");var t="";if(e.pageCount>10)if(e.query.page<6){for(n=1;n<=e.query.page+2;n++)n==e.query.page?t+='<span class="page-to now">'+n+"</span>":t+='<span class="page-to">'+n+"</span>";t+='...<span class="page-to">'+e.pageCount+"</span>"}else if(e.query.page>=6&&e.query.page<e.pageCount-2){t+='<span class="page-to">1</span>...';for(n=e.query.page-2;n<=e.query.page+2;n++)n==e.query.page?t+='<span class="page-to now">'+n+"</span>":t+='<span class="page-to">'+n+"</span>";t+='...<span class="page-to">'+e.pageCount+"</span>"}else{t+='<span class="page-to">1</span>...';for(n=e.query.page-2;n<=e.pageCount;n++)n==e.query.page?t+='<span class="page-to now">'+n+"</span>":t+='<span class="page-to">'+n+"</span>"}else for(var n=1;n<=e.pageCount;n++)n==e.query.page?t+='<span class="page-to now">'+n+"</span>":t+='<span class="page-to">'+n+"</span>";$(a).find(".pre").after(t)}else $(a).find(".table-page").html("")},!0);var s=e.$eval(t.tablePage);$(a).on("click",".page-to",function(){$(this).hasClass("now")||s.getList(parseInt($(this).text()))}),$(a).on("click",".pre",function(){$(this).hasClass("disabled")||s.getList(s.query.page-1)}),$(a).on("click",".next",function(){$(this).hasClass("disabled")||s.getList(s.query.page+1)})}}});