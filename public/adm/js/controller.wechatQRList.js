app.controller("editQrcode",["$scope","http",function(e,t){e.id,e.count=0,e.qrcode={content:"",limit:"0",type:"1"},e.ngDialogData.qrcode&&(e.id=e.qrcode.id=e.ngDialogData.qrcode.id,e.count=e.ngDialogData.qrcode.count,e.qrcode.wechat=e.ngDialogData.qrcode.wechat_id,e.qrcode.type=e.ngDialogData.qrcode.type+"",e.qrcode.limit=e.ngDialogData.qrcode.limit,e.qrcode.url=e.ngDialogData.qrcode.url),e.check=function(){return e.qrcode.wechat?""==e.qrcode.limit?(e.error=!0,e.errorMsg="请填写限额！",!1):!(!e.id&&!e.qrcode.content)||(e.error=!0,e.errorMsg="请上传二维码！",!1):(e.error=!0,e.errorMsg="请填写微信号！",!1)},e.save=function(){var o;!e.loading&&e.check()&&(e.loading=!0,delete(o=angular.copy(e.qrcode)).url,t.post("/admin/addQrcode",o,function(t){e.loading=!1,0==t.status?e.closeThisDialog(t):(e.error=!0,e.errorMsg=t.msg)}))},e.update=function(){var o;!e.loading&&e.check()&&(e.loading=!0,(o=angular.copy(e.qrcode)).content||delete o.content,delete o.url,t.post("/admin/updateQrcode/"+e.id,o,function(t){e.loading=!1,0==t.status?e.closeThisDialog(t):(e.error=!0,e.errorMsg=t.msg)}))},e.$watch("qrcode.content",function(){e.qrcode.content&&(e.qrcode.url=e.qrcode.content)})}]),app.controller("wechatQRList",["$scope","$rootScope","Table","http","ngDialog","$stateParams","Tip",function(e,t,o,a,n,c,i){e.companyInfo={},a.get("/admin/companies",{page:1,perPage:999},function(t){if(t.data)for(var o=0;o<t.data.length;o++)e.companyInfo[t.data[o].id]=t.data[o]}),e.table=o.init({link:"/admin/qrcodes",query:{}}),e.table.getList(),e.total=e.table.total,e.editQR=function(t){n.open({template:"template/wechatQRDialog.html",controller:"editQrcode",data:{qrcode:t}}).closePromise.then(function(t){t.value&&0==t.value.status&&(i.success("保存成功!"),setTimeout(function(){e.table.getList()},1e3))})},e.deleteQR=function(t){n.open({template:'<div class="confirm-dialog">             <h2>您确定要删除微信号为“'+t.wechat_id+'”的二维码吗？</h2>            <div align="center">                <button type="button" class="btn btn-red" ng-click="closeThisDialog(\'CONFIRM\')">确定</button>                <button type="button" class="btn" ng-click="closeThisDialog()">取消</button>            </div></div>',plain:!0}).closePromise.then(function(o){o.value&&"CONFIRM"==o.value&&a.get("/admin/deleteQrcode/"+t.id,{},function(t){0==t.status?(i.success("删除成功!"),e.table.getList(1)):i.error(t.msg)})})},e.$on("fileUploaded",function(){e.table.getList()}),e.disable=function(t,o){a.post("/admin/disableQrcode/"+t.id,{disable:o},function(t){0==t.status&&(i.success("操作成功!"),e.table.getList())})}}]),app.directive("pkgUpload",["Tip",function(e){return{restrict:"AE",link:function(t,o,a,n){o.on("change",function(a){if(a.target.files.length>0){var n=a.target.files[0];if(-1==n.name.indexOf(".zip"))return void e.error("请上传ZIP格式的压缩包");var c=new FormData;c.append("file",n),$.ajax({url:"/admin/batchUploadQrcode",type:"POST",data:c,processData:!1,contentType:!1,success:function(a){0==a.status?(o[0].value="",e.success(a.msg),t.$emit("fileUploaded",n)):e.error(a.msg)},error:function(t){e.error("服务器内部错误，上传失败!")}})}})}}}]);