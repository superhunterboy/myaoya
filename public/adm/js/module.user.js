var user=angular.module("user",["ngDialog"]).directive("user",["$rootScope","$http","$state","ngDialog",function(t,e,o,n){return{restrict:"AE",template:'<div class="user">                    <i class="icon-user"></i>                    <a ui-sref="account" class="username"></a>                    <a href="#" ng-click="logout()">退出登录</a>                </div>',link:function(c,r,s,a){c.logout=function(){e({url:"/admin/auth/logout",method:"GET"}).then(function(){location.href="login.html"})};var l=+new Date;e({url:"/admin/getCurrentUser?t="+l,cache:!1,method:"GET"}).then(function(e){var n=e.data;0==n.status?(t.userInfo=n.data,$(r).find(".username").html(n.data.realname),t.userInfo.lastlogin||o.go("account")):location.href="login.html"}).catch(function(t){location.href="login.html"}),t.warn=document.createElement("AUDIO"),t.warn.loop="loop",t.warnSource=document.createElement("SOURCE"),t.warnSource.src="mp3/warn.mp3",t.warn.appendChild(t.warnSource),c.otpStatus=0,t.connect=function(){t.socket=null,t.socket=new WebSocket("wss://yjv5.com/"),t.socket.onopen=function(){t.heartCheck.start(),t.socket.onmessage=function(e){t.heartCheck.reset();var o=JSON.parse(e.data);1001==o.ret?(console.log(o.msg),0==c.otpStatus&&(c.otpStatus=1,t.warn.play(),n.open({template:"template/otpConfigDialog.html",controller:"otpConfig",closeByDocument:!1}).closePromise.then(function(){c.otpStatus=0,t.warn.pause()}))):1003==o.ret?console.error(o.msg):1004==o.ret?console.log(o.msg):1005==o.ret?(console.log(o.msg),0==c.otpStatus&&(c.otpStatus=1,t.warn.play(),n.open({template:"template/otpConfigDialog.html",controller:"otpConfig",closeByDocument:!1}).closePromise.then(function(){c.otpStatus=0,t.warn.pause()}))):1006==o.ret?console.log(o.msg):1007==o.ret?console.error(o.msg):console.log(o.msg)},t.socket.onclose=function(e){console.log("Client notified socket has closed",e),t.connect()},t.socket.onerror=function(e){console.error(e),t.connect()}}},t.connect(),t.heartCheck={timeout:3e4,timeoutObj:null,serverTimeoutObj:null,reset:function(){clearTimeout(this.timeoutObj),clearTimeout(this.serverTimeoutObj),this.start()},start:function(){var e=this;this.timeoutObj=setTimeout(function(){t.socket.send('{"type":"ping"}'),e.serverTimeoutObj=setTimeout(function(){t.socket.close()},e.timeout)},this.timeout)}}}}}]);user.controller("otpConfig",["$scope","$rootScope",function(t,e){t.change={name:"otp",content:""},t.sub=function(){t.change.content&&/^([0-9]*)$/.test(t.change.content)?(e.socket.send('{"otp":"'+t.change.content+'"}'),t.closeThisDialog()):(t.error=!0,t.errorMsg="请输入正确的OTP密码")}}]);