app.controller("editUser",["$scope","http",function(n,e){if(n.user={},n.userCompanyIds=[],n.companyInfo=angular.copy(n.ngDialogData.companyInfo),n.ngDialogData.user){n.userId=n.ngDialogData.user.id,n.user.id=n.ngDialogData.user.id,n.user.type=""+n.ngDialogData.user.type,n.user.realname=n.ngDialogData.user.realname,n.user.username=n.ngDialogData.user.username,n.user.company_ids=n.ngDialogData.user.company_ids,n.userCompanyIds=n.user.company_ids.split(",");for(var o=0;o<n.userCompanyIds.length;o++)n.companyInfo[n.userCompanyIds[o]].checked=!0}n.check=function(){if(!n.user.username)return n.error=!0,n.errorMsg="请填写用户名！",!1;n.userCompanyIds=[];for(var e in n.companyInfo)n.companyInfo[e].checked&&n.userCompanyIds.push(n.companyInfo[e].id);return n.user.company_ids=n.userCompanyIds.join(","),n.userId||(n.user.password="000000"),!0},n.save=function(){!n.loading&&n.check()&&(n.loading=!0,e.post("/admin/users",n.user,function(e){n.loading=!1,0==e.status?n.closeThisDialog(e):(n.error=!0,n.errorMsg=e.msg)}))},n.update=function(){!n.loading&&n.check()&&(n.loading=!0,e.put("/admin/users/"+n.userId,n.user,function(e){n.loading=!1,0==e.status?n.closeThisDialog(e):(n.error=!0,n.errorMsg=e.msg)}))}}]),app.controller("userList",["$scope","$rootScope","Table","http","ngDialog","Tip",function(n,e,o,s,t,a){e.patchName="userList",n.table=o.init({link:"/admin/users"}),n.table.getList(),n.companyInfo={},s.get("/admin/getCompaniesByCurrentUser",{},function(e){if(e.data)for(var o=0;o<e.data.length;o++)n.companyInfo[e.data[o].id]=e.data[o]}),n.resetPassword=function(n){t.open({template:'<div class="confirm-dialog">                 <h2>您确定要将用户“'+n.username+'”的密码重置吗？</h2>                <div align="center">                    <button type="button" class="btn btn-red" ng-click="closeThisDialog(\'CONFIRM\')">确定</button>                    <button type="button" class="btn btn-default" ng-click="closeThisDialog()">取消</button>                </div></div>',plain:!0}).closePromise.then(function(e){e.value&&"CONFIRM"==e.value&&s.get("/admin/resetPassword/"+n.id,{},function(n){0==n.status?a.success("重置密码成功"):a.error(n.msg)})})},n.disableUser=function(n,e){s.put("/admin/endisableUser/"+n.id,{status:e},function(o){0==o.status&&(n.status=e)})},n.editUser=function(e){t.open({template:"template/userDialog.html",controller:"editUser",data:{user:e,companyInfo:n.companyInfo}}).closePromise.then(function(e){e.value&&0==e.value.status&&n.table.getList()})},s.get("/isEnableOtp",{},function(n){0==n.status&&(e.userInfo.isEnableOtp=n.data.isBind)}),n.bindOTP=function(){t.open({template:"template/bindOTPDialog.html",controller:"bindOTP"}).closePromise.then(function(n){n.value&&0==n.value.status&&(a.success("绑定成功！"),e.userInfo.isEnableOtp=1)})},n.unbindOTP=function(){t.open({template:"template/unbindOTPDialog.html",controller:"unbindOTP"}).closePromise.then(function(n){n.value&&0==n.value.status&&(a.success("解绑成功！"),e.userInfo.isEnableOtp=0)})}}]),app.controller("bindOTP",["$scope","http",function(n,e){n.bind={},e.get("/admin/bindOneTimePwd",{},function(e){0==e.status&&(n.bind.qrcode=e.data.qrcode)}),n.sub=function(){n.loading||(n.loading=!0,e.post("/admin/verifyBindOneTimePwd",{code:n.bind.code},function(e){n.loading=!1,0==e.status?n.closeThisDialog(e):(n.error=!0,n.errorMsg=e.msg)}))}}]),app.controller("unbindOTP",["$scope","http",function(n,e){n.unbind={},n.sub=function(){n.loading||(n.loading=!0,e.post("/admin/verifyUnbindOneTimePwd",{code:n.unbind.code},function(e){n.loading=!1,0==e.status?n.closeThisDialog(e):(n.error=!0,n.errorMsg=e.msg)}))}}]);